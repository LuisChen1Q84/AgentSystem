# MCP 故障排查指南

## 常见问题

### 1. npx 命令找不到

**症状**:
```
command not found: npx
```

**解决**:
```bash
# 安装 Node.js 18+
brew install node

# 验证安装
node --version  # v18.0.0+
npm --version
npx --version
```

---

### 2. MCP服务器启动失败

**症状**:
```
Failed to start MCP server: filesystem
```

**排查步骤**:

1. **检查配置文件语法**
```bash
python3 -m json.tool config/mcp_servers.json > /dev/null && echo "JSON有效" || echo "JSON无效"
```

2. **手动测试服务器**
```bashn# 测试 filesystem 服务器
npx -y @modelcontextprotocol/server-filesystem /Volumes/Luis_MacData/AgentSystem

# 测试 fetch 服务器
npx -y @modelcontextprotocol/server-fetch
```

3. **查看日志**
```bash
ls -la 日志/mcp/
cat 日志/mcp/mcp_calls.log
```

---

### 3. API认证失败

**症状**:
```
Authentication failed: GitHub API
```

**解决**:

1. **检查环境变量**
```bash
echo $GITHUB_TOKEN
echo $BRAVE_API_KEY
```

2. **确认 .env 文件存在**
```bash
ls -la .env
cat .env
```

3. **验证API密钥有效**
```bash
# 测试 GitHub Token
curl -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user

# 测试 Brave API
curl "https://api.search.brave.com/res/v1/web/search?q=test" -H "X-Subscription-Token: $BRAVE_API_KEY"
```

---

### 4. 文件系统访问被拒绝

**症状**:
```
Access denied: path outside allowed directories
```

**原因**: filesystem服务器只能访问配置的路径

**解决**:
编辑 `config/mcp_servers.json`:
```json
{
  "mcpServers": {
    "filesystem": {
      "args": [
        "-y",
        "@modelcontextprotocol/server-filesystem",
        "/Volumes/Luis_MacData/AgentSystem",
        "/path/to/additional/dir"  // 添加允许的路径
      ]
    }
  }
}
```

---

### 5. 网络请求被拒绝

**症状**:
```
Domain not in whitelist: api.example.com
```

**解决**:
编辑 `config/mcp_servers.json`:
```json
{
  "mcpServers": {
    "fetch": {
      "env": {
        "FETCH_DOMAIN_WHITELIST": "api.github.com,www.pbc.gov.cn,api.example.com"
      }
    }
  }
}
```

---

## 调试技巧

### 启用详细日志

在 `config/mcp_servers.json` 中:
```json
{
  "settings": {
    "logging": {
      "level": "debug",
      "saveToFile": true
    }
  }
}
```

### 测试单个服务器

```bash
# 使用 make 命令
make mcp-test

# 或者直接调用
npx -y @modelcontextprotocol/server-[name] [args]
```

### 检查服务器列表

```bash
make mcp-list
```

---

## 获取帮助

1. **MCP官方文档**: https://modelcontextprotocol.io/
2. **MCP服务器列表**: https://github.com/modelcontextprotocol/servers
3. **查看AgentSystem日志**: `日志/mcp/mcp_calls.log`
