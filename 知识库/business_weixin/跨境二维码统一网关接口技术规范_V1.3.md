# 跨境二维码统一网关接口技术规范

**开发稿 V1.3**

*202X年9月19日*

---

## 第1章 引言

### 1.1 背景

随着跨境支付的快速发展，境内机构与境外机构之间的二维码支付需求日益增长。为了规范跨境二维码支付业务的技术实现，统一境内机构与境外机构之间的接口标准，特制定本技术规范。

本规范旨在建立统一的跨境二维码支付网关接口标准，实现不同机构之间的互联互通，促进跨境支付业务的健康发展。

### 1.2 目标

1. **统一接口标准**：建立统一的跨境二维码支付接口规范，实现不同机构之间的无缝对接
2. **规范业务流程**：明确跨境二维码支付各环节的业务处理流程和操作规范
3. **保障交易安全**：建立完善的安全防护机制，确保跨境支付交易的安全性
4. **提升处理效率**：优化接口性能，提高跨境支付业务的处理效率
5. **便于系统集成**：提供清晰的接口文档和技术指导，降低系统集成成本

### 1.3 适用范围

**适用场景**：
- 境内机构与境外机构之间的二维码支付业务
- 跨境扫码支付、刷脸支付等新型支付方式
- 跨境二维码支付相关的查询、退款、撤单等业务
- 参与跨境二维码支付业务的相关系统

**不适用场景**：
- 境内二维码支付业务（遵循国内相关规范）
- 传统银行卡跨境支付业务
- 其他非二维码形式的跨境支付业务

### 1.4 术语和定义

| 术语 | 定义 |
|------|------|
| 跨境二维码支付 | 境内用户通过扫描境外商户展示的二维码，或者境外用户通过扫描境内商户展示的二维码完成的支付交易 |
| 统一网关 | 部署在境内的跨境二维码支付统一接入系统，负责处理境内机构与境外机构之间的支付请求和响应 |
| 境内机构 | 在境内注册并开展二维码支付业务的金融机构或支付机构 |
| 境外机构 | 在境外注册并开展二维码支付业务的金融机构或支付机构 |
| 交易流水号 | 在跨境二维码支付交易过程中，由系统生成的唯一标识每笔交易的编号 |
| 幂等性 | 同一笔交易多次请求与单次请求具有相同的效果，不会产生重复交易 |

### 1.5 总体架构

#### 1.5.1 系统架构

跨境二维码统一网关系统架构采用分层设计：

1. **接入层**：负责接收和处理来自各机构的请求，提供统一的接入服务
2. **业务层**：负责处理各类支付业务逻辑，包括交易处理、查询、对账等
3. **路由层**：根据交易类型和机构信息，进行智能路由和负载均衡
4. **清算层**：负责与清算机构对接，完成资金清算和结算
5. **安全层**：负责安全认证、加密解密、风险控制等安全相关功能
6. **监控层**：负责系统监控、日志采集、告警管理等运维功能

#### 1.5.2 网络架构

跨境二维码统一网关采用专线网络连接境内机构，采用国际网络连接境外机构。所有网络通信均采用加密传输，确保数据安全。

---

## 第2章 接口规范

### 2.1 接口总体要求

| 要求项 | 规范 |
|--------|------|
| 通信协议 | HTTPS，TLS版本不低于TLS 1.2 |
| 数据格式 | JSON，字符编码UTF-8 |
| 请求方式 | POST，Content-Type: application/json |

#### 接口地址

| 环境 | 地址 |
|------|------|
| 生产环境 | https://gateway.example.com/api |
| 测试环境 | https://test-gateway.example.com/api |
| 沙箱环境 | https://sandbox-gateway.example.com/api |

### 2.2 基础参数

#### 请求公共参数

| 参数名称 | 参数编码 | 类型 | 必填 | 说明 |
|---------|---------|------|------|------|
| 版本号 | version | String | 是 | 接口版本号，如"1.3" |
| 字符集 | charset | String | 是 | 字符编码，如"UTF-8" |
| 签名方式 | sign_type | String | 是 | 签名算法，如"RSA2" |
| 签名 | sign | String | 是 | 请求签名值 |
| 业务类型 | biz_type | String | 是 | 业务类型编码 |
| 请求时间 | req_time | String | 是 | 请求时间，格式：yyyyMMddHHmmss |
| 请求流水号 | req_id | String | 是 | 请求方生成的唯一流水号 |
| 机构编号 | inst_id | String | 是 | 机构在统一网关的注册编号 |

#### 响应公共参数

| 参数名称 | 参数编码 | 类型 | 必填 | 说明 |
|---------|---------|------|------|------|
| 响应码 | resp_code | String | 是 | 响应状态码，"0000"表示成功 |
| 响应消息 | resp_msg | String | 是 | 响应描述信息 |
| 签名 | sign | String | 是 | 响应签名值 |
| 响应时间 | resp_time | String | 是 | 响应时间，格式：yyyyMMddHHmmss |
| 响应流水号 | resp_id | String | 是 | 统一网关生成的响应流水号 |

### 2.3 交易接口

#### 2.3.1 扫码支付

**请求参数**

| 参数名称 | 参数编码 | 类型 | 必填 | 说明 |
|---------|---------|------|------|------|
| 商户订单号 | out_trade_no | String | 是 | 商户系统中的订单编号 |
| 交易金额 | total_amount | String | 是 | 交易金额，单位：元 |
| 货币类型 | currency | String | 是 | 交易货币类型，如"CNY"、"HKD"等 |
| 交易类型 | trade_type | String | 是 | 交易类型，如"SCAN"、"NATIVE"等 |
| 二维码类型 | qr_type | String | 是 | 二维码类型："01"动态码，"02"静态码 |
| 二维码内容 | qr_content | String | 是 | 二维码解析后的内容 |
| 商品描述 | body | String | 是 | 商品描述信息 |
| 终端类型 | terminal_type | String | 是 | 终端类型，如"01"手机，"02"POS |
| 终端编号 | terminal_id | String | 是 | 终端唯一编号 |

**响应参数**

| 参数名称 | 参数编码 | 类型 | 必填 | 说明 |
|---------|---------|------|------|------|
| 交易流水号 | trade_no | String | 是 | 统一网关生成的交易流水号 |
| 商户订单号 | out_trade_no | String | 是 | 商户系统中的订单编号 |
| 交易状态 | trade_status | String | 是 | "SUCCESS"成功，"FAILED"失败，"PENDING"处理中 |
| 交易金额 | total_amount | String | 是 | 交易金额 |
| 货币类型 | currency | String | 是 | 交易货币类型 |
| 交易时间 | trade_time | String | 是 | 交易完成时间 |

#### 2.3.2 刷脸支付

**请求参数**

| 参数名称 | 参数编码 | 类型 | 必填 | 说明 |
|---------|---------|------|------|------|
| 商户订单号 | out_trade_no | String | 是 | 商户系统中的订单编号 |
| 交易金额 | total_amount | String | 是 | 交易金额 |
| 货币类型 | currency | String | 是 | 交易货币类型 |
| 交易类型 | trade_type | String | 是 | "FACEPAY" |
| 人脸特征值 | face_data | String | 是 | 加密后的人脸特征值 |
| 人脸设备编号 | face_device_id | String | 是 | 人脸识别设备编号 |
| 商户编号 | merchant_id | String | 是 | 商户编号 |
| 终端编号 | terminal_id | String | 是 | 终端编号 |

#### 2.3.3 退款

**请求参数**

| 参数名称 | 参数编码 | 类型 | 必填 | 说明 |
|---------|---------|------|------|------|
| 原交易流水号 | orig_trade_no | String | 是 | 原交易流水号 |
| 商户订单号 | out_trade_no | String | 是 | 商户订单号 |
| 退款单号 | refund_no | String | 是 | 退款单号 |
| 退款金额 | refund_amount | String | 是 | 退款金额 |
| 退款类型 | refund_type | String | 是 | "01"全额退款，"02"部分退款 |

**退款时限要求**

| 交易类型 | 最晚退款时限 |
|---------|-------------|
| 扫码支付 | 交易发生后180天内 |
| 刷脸支付 | 交易发生后180天内 |

### 2.4 查询接口

#### 2.4.1 交易状态查询

根据交易流水号或商户订单号查询交易状态。

#### 2.4.2 批量交易查询

批量查询多个交易的交易状态，支持分页查询，每页最大100条记录。

### 2.5 对账接口

#### 2.5.1 对账文件下载

| 参数名称 | 参数编码 | 类型 | 必填 | 说明 |
|---------|---------|------|------|------|
| 对账日期 | settle_date | String | 是 | 对账日期，格式：yyyyMMdd |
| 对账类型 | recon_type | String | 是 | "01"交易对账，"02"退款对账 |
| 机构编号 | inst_id | String | 是 | 机构编号 |

#### 2.5.2 对账结果上传

对账结果："01"平账，"02"长款，"03"短款，"04"差异

---

## 第3章 业务处理流程

### 3.1 总体流程

1. **用户发起支付**：用户通过扫码或刷脸等方式发起支付请求
2. **机构预处理**：境内机构或境外机构对支付请求进行预处理
3. **统一网关路由**：统一网关接收请求，根据交易类型和机构信息进行路由
4. **交易处理**：统一网关调用相应的清算渠道进行处理
5. **结果返回**：交易结果通过统一网关返回给发起机构
6. **结果通知**：交易结果通知到相关机构和用户

### 3.2 扫码支付流程

#### 3.2.1 主扫流程（境内用户扫境外二维码）

1. 境外商户生成二维码并展示给用户
2. 境内用户使用境内支付APP扫描二维码
3. 境内支付APP解析二维码获取商户信息
4. 境内机构向统一网关发起支付请求
5. 统一网关进行路由和转换
6. 统一网关调用境外清算渠道
7. 清算渠道处理完成后返回结果
8. 统一网关将结果返回境内机构
9. 境内机构展示支付结果给用户

#### 3.2.2 被扫流程（境外用户扫境内二维码）

1. 境内商户生成二维码并展示给用户
2. 境外用户使用境外支付APP扫描二维码
3. 境外支付APP解析二维码获取商户信息
4. 境外机构向统一网关发起支付请求
5. 统一网关进行路由和转换
6. 统一网关调用境内清算渠道
7. 清算渠道处理完成后返回结果
8. 统一网关将结果返回境外机构
9. 境外机构展示支付结果给用户

---

## 第4章 异常处理

### 4.1 异常分类

| 异常类别 | 说明 |
|---------|------|
| 系统异常 | 网络异常、系统繁忙、服务不可用 |
| 业务异常 | 交易超时、余额不足、交易限额、账户状态异常 |
| 参数异常 | 参数缺失、参数格式错误、参数值非法 |

### 4.2 异常响应码

| 异常类别 | 响应码 | 说明 |
|---------|-------|------|
| 系统异常 | A001 | 系统繁忙 |
| 系统异常 | A002 | 服务不可用 |
| 系统异常 | A003 | 网络异常 |
| 业务异常 | B001 | 交易超时 |
| 业务异常 | B002 | 余额不足 |
| 业务异常 | B003 | 交易限额超限 |
| 业务异常 | B004 | 账户状态异常 |
| 参数异常 | C001 | 参数缺失 |
| 参数异常 | C002 | 参数格式错误 |
| 参数异常 | C003 | 参数值非法 |

### 4.3 幂等性处理

- **唯一流水号**：每个请求必须携带唯一的请求流水号
- **去重机制**：系统根据请求流水号进行去重处理
- **状态返回**：对于重复请求，返回原交易结果
- 请求流水号（req_id）有效期为24小时

### 4.4 熔断机制

**熔断触发条件**：
- 错误率超过30%（10分钟内）
- 响应时间超过10秒（连续5笔）
- 服务不可用状态持续1分钟

**熔断处理**：
1. **熔断触发**：暂停向该渠道/机构发起的请求
2. **熔断恢复**：熔断后每隔30秒尝试一次，若成功则恢复
3. **熔断记录**：记录熔断次数和持续时间，用于分析

---

## 第5章 安全要求

### 5.1 通信安全

- 所有接口通信必须使用HTTPS协议
- TLS版本要求不低于TLS 1.2
- 禁用SSLv2、SSLv3、TLS 1.0、TLS 1.1
- 服务器证书必须由可信CA机构颁发
- 证书密钥长度不低于2048位RSA或256位ECC

### 5.2 数据安全

#### 敏感数据脱敏规则

| 敏感字段 | 脱敏规则 |
|---------|---------|
| 身份证号 | 显示前3位和后4位，如：310***********1234 |
| 银行卡号 | 显示前6位和后4位，如：622202********1234 |
| 手机号 | 显示前3位和后4位，如：138****5678 |

### 5.3 身份认证

- **机构认证**：在统一网关完成机构备案，通过数字证书进行身份验证
- **接口认证**：每个接口调用必须包含机构编号、数字签名、时间戳、随机数
- **签名算法**：推荐使用RSA2（SHA256withRSA）签名算法

### 5.4 密钥管理

| 密钥类型 | 更新周期 | 更新方式 |
|---------|---------|---------|
| 传输密钥 | 90天 | 线下分发 |
| 签名密钥 | 1年 | 线下更换 |

---

## 第6章 性能要求

### 6.1 接口响应时间

| 接口类型 | 平均响应时间 | 最大响应时间 |
|---------|------------|------------|
| 支付接口 | 500ms | 3000ms |
| 查询接口 | 300ms | 2000ms |
| 退款接口 | 500ms | 5000ms |
| 对账接口 | 1000ms | 10000ms |

### 6.2 并发能力

- **峰值并发**：支持每秒10000笔交易
- **日处理能力**：支持每日1亿笔交易
- **并发用户数**：支持100万并发用户
- 单个机构至少支持每秒1000笔交易

### 6.3 可用性

- **服务可用性**：99.99%（4个9）
- **计划内维护**：每月不超过4小时
- **计划外故障**：年度累计不超过52分钟
- **故障切换**：自动故障切换时间不超过30秒

---

## 第7章 监控与运维

### 7.1 监控指标

#### 业务监控指标

| 指标名称 | 指标说明 | 告警阈值 |
|---------|---------|---------|
| 交易量 | 每秒/每分钟/每日交易量 | 环比下降30% |
| 成功率 | 交易成功率 | <95% |
| 响应时间 | 接口平均响应时间 | >1000ms |
| 错误率 | 接口错误率 | >5% |

### 7.2 日志要求

#### 日志级别

| 级别 | 使用场景 |
|-----|---------|
| DEBUG | 调试信息，详细流程记录 |
| INFO | 正常业务流程记录 |
| WARN | 警告信息，可能存在问题 |
| ERROR | 错误信息，需要关注 |
| FATAL | 致命错误，需要立即处理 |

### 7.3 告警机制

| 级别 | 说明 | 通知方式 |
|-----|------|---------|
| P1 | 致命故障，服务不可用 | 电话+短信+邮件 |
| P2 | 严重故障，影响部分服务 | 短信+邮件 |
| P3 | 一般故障，影响用户体验 | 邮件 |
| P4 | 预警信息，潜在风险 | 邮件 |

---

## 第8章 附录

### 8.1 错误码对照表

#### 成功响应码

| 响应码 | 说明 |
|-------|------|
| 0000 | 交易成功 |
| 0001 | 交易处理中 |

#### 业务错误码

| 响应码 | 说明 |
|-------|------|
| B001 | 交易超时 |
| B002 | 余额不足 |
| B003 | 交易限额超限 |
| B004 | 账户状态异常 |
| B005 | 交易已存在 |
| B006 | 交易不存在 |
| B007 | 交易已成功，无法撤销 |
| B008 | 退款金额超限 |
| B009 | 退款次数超限 |
| B010 | 超过退款时限 |

### 8.2 版本历史

| 版本号 | 日期 | 修改内容 |
|-------|------|---------|
| V1.0 | 2023年6月1日 | 初始版本 |
| V1.1 | 2023年7月15日 | 增加刷脸支付接口 |
| V1.2 | 2023年8月20日 | 优化安全要求，增加密钥管理规范 |
| V1.3 | 2023年9月19日 | 增加对账接口，完善监控运维要求 |

---

*资料来源：跨境二维码统一网关接口技术规范（开发稿V1.3）*
