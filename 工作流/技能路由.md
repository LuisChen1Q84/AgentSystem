# 技能路由机制

## 功能说明

当用户提出需求时，AI自动判断应该调用哪个技能，无需用户手动指定触发词。

## 路由规则

### 政策分析类

| 需求关键词 | 调用的技能 | 说明 |
|-----------|-----------|------|
| 政策、监管、分析 | policy-pbc | 政策决策参谋 |
| 支付、银行卡、清算 | policy-pbc | 政策决策参谋 |
| 央行、人民银行 | policy-pbc | 政策决策参谋 |
| 基础知识、概念 | policy-pbc-basics | 支付清算基础知识 |
| 关键字、索引 | policy-pbc-keyword-index | 政策关键字索引 |

### 行业研究类

| 需求关键词 | 调用的技能 | 说明 |
|-----------|-----------|------|
| 行业报告、研究 | ai-industry | AI行业研究报告 |
| 金融报告、研究 | finance-industry | 金融行业研究报告 |
| 趋势、分析 | ai-industry / finance-industry | 根据具体领域判断 |

### 文档处理类

| 需求关键词 | 调用的技能 | 说明 |
|-----------|-----------|------|
| Excel、表格、处理 | minimax-xlsx | Excel处理 |
| Word、文档、转换 | minimax-docx | 文档处理 |
| PDF | minimax-docx | 文档处理 |

### 演示类

| 需求关键词 | 调用的技能 | 说明 |
|-----------|-----------|------|
| PPT、演示、麦肯锡 | mckinsey-ppt | McKinsey风格PPT |

### 搜索类

| 需求关键词 | 调用的技能 | 说明 |
|-----------|-----------|------|
| 搜索、查询、找 | serp-api | 搜索API |

### 市场量化类

| 需求关键词 | 调用的技能 | 说明 |
|-----------|-----------|------|
| ETF、指数、行情、K线、买卖点、支撑、压力 | stock-market-hub + mcp-freefirst | 全球市场量化分析 + 免费信源抓取 |

### 图像创作类

| 需求关键词 | 调用的技能 | 说明 |
|-----------|-----------|------|
| 人物、角色、手办、玩偶、肖像 | image-creator-hub | 角色类3D图像生成 |
| 城市、地标、建筑、房间、电影场景 | image-creator-hub | 场景类3D图像生成 |
| Logo、品牌、店铺、产品、广告设计 | image-creator-hub | 产品类3D图像生成 |
| 风格、低多边形、表情包转3D、Knolling、裸眼3D | image-creator-hub | 风格转换3D图像生成 |

### MCP连接类

| 需求关键词 | 调用的技能 | 说明 |
|-----------|-----------|------|
| 读取文件、写文件、遍历目录 | mcp-connector + filesystem | MCP文件操作 |
| 获取网页、API请求 | mcp-connector + fetch | MCP网络请求 |
| 查数据库、SQL查询 | mcp-connector + sqlite/postgres | MCP数据库 |
| GitHub操作、代码搜索 | mcp-connector + github | MCP GitHub |
| 网络搜索 | mcp-connector + brave-search | MCP搜索 |

## 路由流程

```
用户输入
    ↓
分析需求意图
    ↓
匹配路由规则
    ↓
调用对应技能
    ↓
执行任务
```

## 可执行桥接（新增）

- 路由解析：`python3 scripts/skill_router.py route --text "<用户输入>"`
- 路由执行：`python3 scripts/skill_router.py execute --text "<用户输入>" --params-json '{}'`
- Make入口：`make skill-route text='...'`、`make skill-execute text='...'`、`make image-hub text='...'`
- 对于 `mcp-connector + xxx` 规则，会自动桥接到 `scripts/mcp_connector.py` 执行对应 server/tool。
- 对于 `image-creator-hub` 规则，会自动桥接到 `scripts/image_creator_hub.py` 执行风格识别、输入校验与生成交付。
- `cycle-*` 命令默认会执行前置路由（`route` 模式，不阻断主流程）。
- 可选环境变量：
  - `SKILL_ROUTER_CYCLE_MODE=route|execute`（默认 `route`）
  - `SKILL_ROUTER_CYCLE_STRICT=1`（失败时中断周期编排）
  - `SKILL_ROUTER_CYCLE_<CYCLE>_TEXT`（如 `SKILL_ROUTER_CYCLE_WEEKLY_TEXT`）
- 审计落盘：
  - `日志/mcp/preroute/YYYY-MM-DD.jsonl`
  - `日志/mcp/preroute/YYYY-MM-DD.md`

## 冲突消解（新增）

当输入同时包含“执行动作”和“计划词”时，优先按执行动作路由，禁止进入系统规划链路。

### 强优先执行类（优先级最高）

- 关键词示例：`xlsx`、`excel`、`表1`、`表2`、`填报日期`、`更新这张表`、`直接修改原文件`
- 路由：文档处理（`minimax-xlsx`）
- 约束：不得触发 `experiment` / `autopilot` / `plan-task` / `cycle-*`

### 计划词降权规则

- 词汇：`计划`、`打算`、`准备`
- 若同句存在强优先执行类信号，则仅作为语气词，不触发任务拆解或自治计划。

## 调用示例

### 示例1
**用户**：帮我分析一下非银行支付监管条例
**路由**：政策分析 → policy-pbc
**操作**：自动调用policy-pbc技能

### 示例2
**用户**：我想了解一下支付行业的基本概念
**路由**：基础知识 → policy-pbc-basics
**操作**：自动调用policy-pbc-basics技能

### 示例3
**用户**：帮我做个市场分析报告
**路由**：行业研究 → ai-industry 或 finance-industry
**操作**：根据领域自动选择技能

## 默认行为

如果无法明确判断用户意图：
1. 先询问用户具体需求
2. 或者提供多个可能的技能选项

## 强制规则

- 技能路由是**自动执行**，无需用户指定触发词
- 路由判断基于**语义匹配**，而非精确关键词
- 必要时可以**叠加多个技能**（如policy-pbc + serp-api）
