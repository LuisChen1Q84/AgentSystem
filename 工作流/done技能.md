# /done 技能

**版本**: v1.0
**说明**: 会话结束自动生成情景记忆，无需手动整理

## 触发条件

- 用户说"结束"、"完成"、"再见"
- 用户说"/done"
- 任务标记为完成
- 上下文使用超过60%需要重开会话时

## 执行流程

### 1. 提取关键信息

从本次会话中提取：

- **用户需求**：用户最初提出的任务是什么
- **关键讨论点**：本次会话中涉及的重要话题
- **决策**：做出的关键判断或决定
- **后续任务**：需要继续完成的事项
- **产出**：创建或修改的文件列表

### 2. 生成情景记忆

创建文件：`记忆库/情景记忆/2026-MM/MMDD-会话摘要.md`

格式：

```markdown
# 情景记忆：{MMDD}-{会话主题}

**会话ID**: {日期时间戳}
**日期**: YYYY-MM-DD
**时长**: 约X分钟

## 用户需求

{用户最初的需求描述}

## 关键讨论点

- 讨论点1
- 讨论点2
- 讨论点3

## 决策

- 决策1
- 决策2

## 后续任务

- [ ] 任务1
- [ ] 任务2

## 产出文件

- 文件1.md
- 文件2.md

## 知识点

- 提取的新知识点
- 需要沉淀的方法论

## 相关技能

- policy-pbc
- 其他相关技能

---

*本文件由 /done 技能自动生成*
```

### 3. 更新对话历史

在 `日志/对话历史.md` 中追加会话记录

### 4. 任务状态检查

检查是否有未完成的任务：
- 如果有，提示用户是否添加到任务清单
- 如果无，直接结束会话

### 5. 用户偏好学习（Level 3）

从本次会话中提取用户偏好并更新用户画像：

**显式偏好**（用户明确表达）：
- 用户说"我喜欢..."、"以后都用..." → 直接记录
- 执行：`python3 scripts/user_profile.py learn "偏好描述" --evidence "用户原话"`

**隐式偏好**（从行为推断）：
- 用户频繁纠正的行为 → 标记待确认
- 执行：`python3 scripts/user_profile.py learn "偏好描述" --evidence "推断依据" --type inferred`

### 6. 交互模式学习

从本次会话中提取交互模式并更新模式库：

**成功模式**：
- 问题解决后 → 记录成功模式
- 执行：`python3 scripts/pattern_learner.py add -d "描述" -c "分类" -o "解决方案"`

**失败模式**：
- 工具调用失败后 → 记录失败模式
- 执行：`python3 scripts/pattern_learner.py add -d "描述" -c "分类" -s "错误信息" -o "解决方案" --status fail`

### 7. 知识活化

从本次会话中提取新知识点，检查是否需要更新语义记忆：
- 如果有新的方法论或规则 → 提示是否沉淀到语义记忆

## 自动触发场景

### 场景1：用户主动结束
**用户**：好了，今天先这样
**AI**：
```
✓ 检测到会话结束信号
正在生成情景记忆...
✓ 已保存到：记忆库/情景记忆/2026-02/0224-政策分析.md
✓ 后续任务已添加到任务清单
✓ 对话历史已更新
本次会话完成！
```

### 场景2：上下文过载
**AI**：✓ [提醒] 上下文使用已超过60%，建议重开会话。是否现在执行/done？

### 场景3：任务完成
**AI**：✓ 任务已完成。是否需要执行/done生成情景记忆？

## 强制规则

- /done 技能**必须执行**，不能跳过
- 情景记忆文件**必须创建**，不能省略
- 对话历史**必须更新**，不能遗漏
- 后续任务**必须询问**用户是否添加

## 与其他技能的关联

- **记忆提炼机制**：从情景记忆提炼到语义记忆
- **外部知识吸收**：新知识点自动沉淀
- **任务追踪**：后续任务自动添加到清单
